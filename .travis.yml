sudo: required

language: java

jdk:
   - openjdk8
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/bin

# https://github.com/crazy-max/travis-wait-enhanced
before_install: |
  if ! [ -f $HOME/bin/travis-wait-enhanced ]; then
    wget -qO- "https://github.com/crazy-max/travis-wait-enhanced/releases/download/v1.0.0/travis-wait-enhanced_1.0.0_linux_x86_64.tar.gz" | tar -zxvf - travis-wait-enhanced
    mv travis-wait-enhanced $HOME/bin
  fi
  if ! [ -d $HOME/bin/gradle-6.4.1 ]; then
    wget https://services.gradle.org/distributions/gradle-6.4.1-bin.zip
    unzip -qq -d $HOME/bin gradle-6.4.1-bin.zip
  fi
  if ! [ -d $HOME/bin/gradle-6.5.1 ]; then
    wget https://services.gradle.org/distributions/gradle-6.5.1-bin.zip
    unzip -qq -d $HOME/bin gradle-6.5.1-bin.zip
  fi


install: /bin/true

jobs:
  include:
  - stage: deploy
    if: branch = master AND type = push
    script: "cp .travis.settings.xml $HOME/.m2/settings.xml && travis-wait-enhanced --timeout=60m --interval=4m -- ./gradlew clean build publish -DSONATYPE_PASSWORD=$(echo $SONATYPE_PASSWORD) -DSONATYPE_USERNAME=$(echo $SONATYPE_USERNAME)"

  - stage: test
    name: "Gradle 5.6.4"
    if: type = pull_request
    script: "travis-wait-enhanced --timeout=60m --interval=4m -- ./gradlew --no-daemon --stacktrace clean build"

  - stage: test
    name: "Gradle 6.4.1"
    if: type = pull_request
    script:
      - export GRADLE_HOME=$HOME/bin/gradle-6.4.1
      - export PATH=$GRADLE_HOME/bin:$PATH
      - travis-wait-enhanced --timeout=60m --interval=4m -- gradle --no-daemon --stacktrace clean build

  - stage: test
    name: "Gradle 6.5.1"
    if: type = pull_request
    script:
      - export GRADLE_HOME=$HOME/bin/gradle-6.5.1
      - export PATH=$GRADLE_HOME/bin:$PATH
      - travis-wait-enhanced --timeout=60m --interval=4m -- gradle --no-daemon --stacktrace clean build
